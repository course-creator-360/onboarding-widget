<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CC360 Onboarding Widget - Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #0a0a0a;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
    }
    body > * {
      position: relative;
      z-index: 1;
    }
    body::before {
      content: '';
      position: fixed;
      top: -20%;
      left: -15%;
      width: 900px;
      height: 900px;
      background: radial-gradient(circle, rgba(14, 50, 94, 0.5) 0%, rgba(4, 117, 255, 0.35) 20%, transparent 60%);
      pointer-events: none;
      filter: blur(100px);
      z-index: 0;
    }
    body::after {
      content: '';
      position: fixed;
      bottom: -25%;
      right: -15%;
      width: 1000px;
      height: 1000px;
      background: radial-gradient(circle, rgba(4, 117, 255, 0.45) 0%, rgba(4, 117, 255, 0.25) 25%, transparent 65%);
      pointer-events: none;
      filter: blur(120px);
      z-index: 0;
    }
    .demo-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(14, 50, 94, 0.3), 0 8px 24px rgba(4, 117, 255, 0.2);
      max-width: 800px;
      width: 100%;
      padding: 48px;
    }
    h1 {
      color: #0E325E;
      font-size: 32px;
      margin-bottom: 16px;
      font-weight: 700;
      font-family: 'Helvetica Now', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    h2 {
      color: #0475FF;
      font-size: 20px;
      margin-top: 32px;
      margin-bottom: 16px;
      font-weight: 600;
      font-family: 'Helvetica Now', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    p {
      color: #6c757d;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    .info-box {
      background: #f5f7fa;
      border-left: 4px solid #0475FF;
      padding: 16px;
      margin: 24px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(4, 117, 255, 0.08);
    }
    .info-box strong {
      color: #2c3e50;
      display: block;
      margin-bottom: 8px;
      font-family: 'Helvetica Now', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    code {
      background: #f5f7fa;
      padding: 3px 8px;
      border-radius: 6px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      color: #0475FF;
      font-weight: 500;
    }
    .controls {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    button {
      background: linear-gradient(135deg, #0E325E 0%, #0475FF 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(4, 117, 255, 0.2);
      font-family: 'Helvetica Now', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(4, 117, 255, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button.secondary {
      background: #111D2C;
      box-shadow: 0 2px 8px rgba(17, 29, 44, 0.2);
    }
    button.secondary:hover {
      background: #1a2a3d;
      box-shadow: 0 4px 16px rgba(17, 29, 44, 0.3);
    }
    button.success {
      background: linear-gradient(135deg, #0E325E 0%, #00D9A3 100%);
      box-shadow: 0 2px 8px rgba(0, 217, 163, 0.2);
    }
    button.success:hover {
      box-shadow: 0 4px 16px rgba(0, 217, 163, 0.4);
    }
    .endpoint-list {
      background: linear-gradient(135deg, rgba(14, 50, 94, 0.03) 0%, rgba(4, 117, 255, 0.03) 100%);
      padding: 20px;
      border-radius: 12px;
      margin: 16px 0;
      border: 1px solid rgba(4, 117, 255, 0.1);
    }
    .endpoint-list li {
      margin-bottom: 8px;
      color: #495057;
    }
    .status-display {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      display: none;
    }
    .status-display.show {
      display: block;
    }
    .status-display pre {
      background: white;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      margin-top: 8px;
    }
    .badge {
      display: inline-block;
      background: linear-gradient(135deg, #0475FF 0%, #00D9A3 100%);
      color: white;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
      box-shadow: 0 2px 8px rgba(4, 117, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="demo-container">
    <h1>üöÄ CC360 Onboarding Widget</h1>
    <p class="badge">Demo Mode</p>
    <p>
      This is a demo page for the CourseCreator360 onboarding widget. 
      The widget appears in the bottom-right corner and tracks onboarding progress.
    </p>

    <div class="info-box">
      <strong>Widget Configuration:</strong>
      <div style="margin-top: 12px;">
        <div id="locationSelector" style="background: linear-gradient(135deg, rgba(14, 50, 94, 0.05) 0%, rgba(4, 117, 255, 0.05) 100%); border: 2px solid #0475FF; padding: 16px; border-radius: 10px; margin-bottom: 12px; display: none; box-shadow: 0 2px 8px rgba(4, 117, 255, 0.1);">
          <strong style="color: #0E325E; display: block; margin-bottom: 10px; font-size: 15px;">üéØ Select a Location:</strong>
          <select id="locationDropdown" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e5e7eb; font-size: 14px; margin-bottom: 10px; outline: none; transition: border-color 0.2s;">
            <option value="">Loading locations...</option>
          </select>
          <button onclick="selectLocation()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #0E325E 0%, #0475FF 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 2px 8px rgba(4, 117, 255, 0.2); transition: all 0.2s;">
            Load Selected Location
          </button>
        </div>
        <div id="locationWarning" style="background: linear-gradient(135deg, rgba(255, 47, 0, 0.08) 0%, rgba(226, 255, 0, 0.08) 100%); border: 2px solid #FF2F00; padding: 14px; border-radius: 10px; margin-bottom: 12px; display: none; box-shadow: 0 2px 8px rgba(255, 47, 0, 0.1);">
          <strong style="color: #c41e00; display: block; margin-bottom: 8px; font-size: 15px;">‚ö†Ô∏è Manual Testing:</strong>
          <p style="margin: 0; font-size: 13px; color: #6c4a00; line-height: 1.5;">
            You can also manually add <code style="background: rgba(255,255,255,0.6); color: #0475FF; padding: 3px 8px; border-radius: 4px;">?locationId=YOUR_LOCATION_ID</code> to the URL.
            <br><br>
            Example: <code style="background: rgba(255,255,255,0.6); color: #0475FF; padding: 3px 8px; border-radius: 4px;">?locationId=L851uHvru1ipOe8DIwNS</code>
          </p>
        </div>
        <p style="margin: 0; font-size: 13px; color: #6c757d;">
          Current Location: <code id="currentLocationId">None selected</code><br>
          <span id="locationValidation" style="display: none; margin-top: 4px; display: block;"></span>
          API Base: <code id="apiBaseUrl">Loading...</code>
        </p>
      </div>
    </div>

    <h2>Agency Setup</h2>
    <p>Configure agency-level authorization (one-time setup):</p>
    
    <div class="controls">
      <button id="setupAgencyBtn" onclick="setupAgency()">üîë Setup Agency OAuth</button>
      <button onclick="checkAgencyStatus()">Check Agency Status</button>
      <button class="secondary" onclick="clearAgencyAuth()">Clear Agency Auth</button>
    </div>

    <h2>Widget Testing</h2>
    <p>Test widget behavior and onboarding progress:</p>
    
    <div class="controls">
      <button onclick="checkInstallation()">Check Installation</button>
      <button onclick="resetWidget()">Reset Widget State</button>
      <button class="secondary" onclick="reloadWidget()">Reload Widget</button>
      <button class="secondary" onclick="clearLocationData()" style="background: #dc3545;">üóëÔ∏è Clear Location Data</button>
    </div>

    <h2>Onboarding Progress</h2>
    <p>Test onboarding steps for the current location:</p>
    
    <div style="background: linear-gradient(135deg, rgba(255, 47, 0, 0.06) 0%, rgba(226, 255, 0, 0.06) 100%); border-left: 4px solid #FF2F00; padding: 14px; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(255, 47, 0, 0.08);">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="skipApiChecks" style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px; accent-color: #0475FF;" onchange="toggleApiChecks()">
        <span style="color: #6c4a00; font-size: 14px; font-weight: 500;">
          <strong style="color: #c41e00;">Skip GHL API checks</strong> - Enable this to test toggles without real API overwriting your changes
        </span>
      </label>
      <p style="margin: 10px 0 0 28px; font-size: 12px; color: #6c4a00; line-height: 1.5;">
        When enabled, manual toggles will persist. When disabled, real GHL data will be reflected.
      </p>
    </div>
    
    <div class="controls">
      <button onclick="toggleStep('locationVerified')">Toggle Location Verified</button>
      <button onclick="toggleStep('paymentIntegrated')">Toggle Payment</button>
      <button onclick="toggleStep('courseCreated')">Toggle Course</button>
      <button onclick="toggleStep('domainConnected')">Toggle Domain</button>
      <button class="secondary" onclick="resetAll()">Reset All</button>
      <button class="secondary" onclick="checkStatus()">Check Status</button>
    </div>

    <div id="status-display" class="status-display">
      <strong>Current Status:</strong>
      <pre id="status-content"></pre>
    </div>

    <h2>Available Endpoints</h2>
    <div class="endpoint-list">
      <ul>
        <li><code>GET /api/status?locationId=...&skipApiChecks=true</code> - Get current checklist status (skipApiChecks prevents real API overwrites)</li>
        <li><code>GET /api/events?locationId=...</code> - SSE stream for real-time updates</li>
        <li><code>GET /api/agency/locations</code> - Get all locations from agency (requires OAuth)</li>
        <li><code>GET /api/location/validate?locationId=...</code> - Validate if locationId exists in agency</li>
        <li><code>GET /api/onboarding/:locationId/check-products</code> - Check if products exist (polling)</li>
        <li><code>POST /api/dismiss</code> - Dismiss the widget</li>
        <li><code>POST /api/onboarding/toggle</code> - Toggle a specific onboarding field (for testing)</li>
        <li><code>POST /api/onboarding/update</code> - Update onboarding status fields (for testing)</li>
        <li><code>POST /api/test/clear-location</code> - Clear location data (keep agency auth)</li>
        <li><code>GET /api/oauth/install</code> - OAuth installation flow</li>
        <li><code>POST /api/webhooks/ghl</code> - GHL webhook receiver</li>
      </ul>
    </div>

    <h2>How It Works</h2>
    <p>
      <strong>üéØ Auto-Detection:</strong> The widget now automatically detects the location ID when embedded in the GHL dashboard. 
      It checks multiple sources including the URL path, query parameters, GHL context objects, and parent window URLs (for iframes). 
      This eliminates the need for manual configuration in production.
    </p>
    <p>
      <strong>üîÑ Real-Time Updates:</strong> The widget uses Server-Sent Events (SSE) for real-time updates. When you click 
      the testing buttons above, the widget will automatically update without refreshing the page.
    </p>
    <p>
      <strong>üì¶ Product Detection:</strong> The widget uses <strong>fetch interception</strong> to detect 
      when products/courses are created in GHL's admin dashboard. When the widget is loaded as custom JS 
      in the agency, it intercepts GHL's API calls and triggers a status check when product creation is detected.
    </p>
    <p> 
      <strong>üîó Webhook Integration:</strong> Other events (domain connection, payment integration, orders) use webhooks from GoHighLevel 
      for real-time updates.
    </p>
  </div>

  <!-- Widget loading script -->
  <script>
    let LOCATION_ID = null;
    let API_BASE = window.location.origin; // Use current origin by default
    let availableLocations = [];

    // Detect location ID from URL (for demo/testing)
    function detectLocationFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const locationId = urlParams.get('locationId');
      if (locationId) {
        LOCATION_ID = locationId;
        document.getElementById('currentLocationId').textContent = locationId;
        console.log('Detected location ID from URL:', locationId);
        validateCurrentLocation();
        return locationId;
      }
      
      // Check URL path
      const pathMatch = window.location.pathname.match(/\/location\/([^\/]+)/);
      if (pathMatch && pathMatch[1]) {
        LOCATION_ID = pathMatch[1];
        document.getElementById('currentLocationId').textContent = pathMatch[1];
        console.log('Detected location ID from path:', pathMatch[1]);
        validateCurrentLocation();
        return pathMatch[1];
      }
      
      document.getElementById('currentLocationId').textContent = 'None selected';
      return null;
    }

    // Validate the current location ID
    async function validateCurrentLocation() {
      if (!LOCATION_ID) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/location/validate?locationId=${LOCATION_ID}`);
        const data = await response.json();
        
        const validationEl = document.getElementById('locationValidation');
        if (data.valid) {
          validationEl.innerHTML = `<span style="color: #0475FF; font-weight: 600;">‚úì Valid location: ${data.location.name}</span>`;
          validationEl.style.display = 'block';
        } else {
          validationEl.innerHTML = `<span style="color: #FF2F00; font-weight: 600;">‚úó Invalid location ID - not found in agency</span>`;
          validationEl.style.display = 'block';
        }
      } catch (error) {
        console.error('Error validating location:', error);
      }
    }

    // Load available locations from the agency
    async function loadAgencyLocations() {
      try {
        const response = await fetch(`${API_BASE}/api/agency/locations`);
        
        if (!response.ok) {
          if (response.status === 401) {
            // Not authorized yet - show manual mode
            document.getElementById('locationWarning').style.display = 'block';
            return;
          }
          throw new Error('Failed to fetch locations');
        }
        
        const data = await response.json();
        availableLocations = data.locations || [];
        
        if (availableLocations.length === 0) {
          document.getElementById('locationWarning').style.display = 'block';
          return;
        }
        
        // Populate dropdown
        const dropdown = document.getElementById('locationDropdown');
        dropdown.innerHTML = '<option value="">-- Select a location --</option>';
        
        availableLocations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc.id;
          option.textContent = `${loc.name} (${loc.id})`;
          dropdown.appendChild(option);
        });
        
        // Show the selector
        document.getElementById('locationSelector').style.display = 'block';
        
        console.log(`Loaded ${availableLocations.length} locations from agency`);
        
      } catch (error) {
        console.error('Error loading locations:', error);
        document.getElementById('locationWarning').style.display = 'block';
      }
    }

    // Handle location selection
    function selectLocation() {
      const dropdown = document.getElementById('locationDropdown');
      const selectedId = dropdown.value;
      
      if (!selectedId) {
        alert('Please select a location from the dropdown');
        return;
      }
      
      // Update URL with selected location
      const newUrl = `${window.location.pathname}?locationId=${selectedId}`;
      window.location.href = newUrl;
    }
    
    // Update agency button status
    async function updateAgencyButtonStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/agency/status`);
        const data = await response.json();
        
        const button = document.getElementById('setupAgencyBtn');
        if (data.authorized) {
          button.textContent = '‚úì Agency OAuth Connected';
          button.classList.add('success');
          button.onclick = () => {
            if (confirm('Agency OAuth is already set up. Do you want to re-authorize?')) {
              setupAgency();
            }
          };
        } else {
          button.textContent = 'üîë Setup Agency OAuth';
          button.classList.remove('success');
          button.onclick = setupAgency;
        }
      } catch (error) {
        console.error('Error checking agency status:', error);
      }
    }
    
    // Load API base and widget on page load
    window.addEventListener('DOMContentLoaded', async function() {
      // Always use current origin for API calls (fixes Vercel preview URL issues)
      API_BASE = window.location.origin;
      document.getElementById('apiBaseUrl').textContent = API_BASE;
      
      // Detect location ID from URL
      detectLocationFromUrl();
      
      // Check agency OAuth status and update button
      await updateAgencyButtonStatus();
      
      // Load available locations from agency
      await loadAgencyLocations();
      
      // Auto-load widget - it will auto-detect location ID from URL
      const script = document.createElement('script');
      script.src = `${API_BASE}/widget.js`;
      script.setAttribute('data-api', API_BASE);
      // Note: no data-location attribute - widget will auto-detect from UserContext/URL
      document.body.appendChild(script);
      console.log('Widget loaded - will auto-detect location ID');
    });
  </script>

  <script>
    let currentStatus = {};
    let skipApiChecks = false;

    function toggleApiChecks() {
      skipApiChecks = document.getElementById('skipApiChecks').checked;
      console.log('[Demo] Skip API checks:', skipApiChecks);
      
      // Reload widget with new setting
      const existingWidget = document.getElementById('cc360-onboarding-widget');
      if (existingWidget) existingWidget.remove();
      const script = document.createElement('script');
      script.src = `${API_BASE}/widget.js`;
      script.setAttribute('data-api', API_BASE);
      if (skipApiChecks) {
        script.setAttribute('data-skip-api-checks', 'true');
      }
      document.body.appendChild(script);
    }

    async function checkStatus() {
      if (!LOCATION_ID) {
        showError('No location selected. Please select a location from the dropdown above or add ?locationId=YOUR_LOCATION_ID to the URL.');
        return;
      }
      try {
        const skipParam = skipApiChecks ? '&skipApiChecks=true' : '';
        const response = await fetch(`${API_BASE}/api/status?locationId=${LOCATION_ID}${skipParam}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        currentStatus = await response.json();
        displayStatus(currentStatus);
      } catch (error) {
        console.error('Error fetching status:', error);
        showError(`Failed to fetch status: ${error.message}`);
      }
    }

    async function toggleStep(step) {
      if (!LOCATION_ID) {
        showError('No location selected. Please select a location from the dropdown above.');
        return;
      }
      
      // Show loading indicator
      const statusDisplay = document.getElementById('status-display');
      const statusContent = document.getElementById('status-content');
      statusDisplay.classList.add('show');
      statusContent.textContent = `Toggling ${step}...`;
      
      try {
        console.log(`[Toggle] Fetching current status for ${LOCATION_ID}...`);
        
        // Step 1: Get current status
        const skipParam = skipApiChecks ? '&skipApiChecks=true' : '';
        const statusResponse = await fetch(`${API_BASE}/api/status?locationId=${LOCATION_ID}${skipParam}`);
        if (!statusResponse.ok) {
          throw new Error(`Failed to fetch status: HTTP ${statusResponse.status}`);
        }
        
        const currentData = await statusResponse.json();
        console.log('[Toggle] Current status:', currentData);
        
        // Step 2: Toggle only the specific field
        const newValue = !currentData[step];
        console.log(`[Toggle] Toggling ${step} from ${currentData[step]} to ${newValue}`);
        
        const updates = {
          [step]: newValue
        };
        
        // Step 3: Update only this field via API
        console.log('[Toggle] Sending update to API...', updates);
        const updateResponse = await fetch(`${API_BASE}/api/onboarding/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            locationId: LOCATION_ID,
            updates: updates
          })
        });
        
        if (!updateResponse.ok) {
          const errorData = await updateResponse.json();
          throw new Error(errorData.error || `HTTP ${updateResponse.status}: Update failed`);
        }
        
        const updatedStatus = await updateResponse.json();
        console.log('[Toggle] ‚úÖ Updated status:', updatedStatus);
        displayStatus(updatedStatus);
        
        // Trigger immediate widget refresh with skipApiChecks setting
        if (window.cc360Widget && typeof window.cc360Widget.refresh === 'function') {
          console.log('[Toggle] Triggering immediate widget refresh (skipApiChecks:', skipApiChecks, ')...');
          await window.cc360Widget.refresh(skipApiChecks);
        } else {
          console.log('[Toggle] Widget refresh not available, will update on next poll');
        }
        
        // Show success message in the status box instead of alert
        const stepName = step.replace(/([A-Z])/g, ' $1').toLowerCase();
        statusContent.textContent = `‚úÖ Successfully toggled ${stepName} to: ${newValue}\n\n${JSON.stringify(updatedStatus, null, 2)}`;
        
      } catch (error) {
        console.error('Error toggling step:', error);
        showError(`Failed to toggle ${step}: ${error.message}`);
        statusContent.textContent = `‚ùå Error: ${error.message}`;
      }
    }

    // Helper to show errors
    function showError(message) {
      const statusDisplay = document.getElementById('status-display');
      const statusContent = document.getElementById('status-content');
      statusContent.textContent = `‚ùå ${message}`;
      statusDisplay.classList.add('show');
      statusDisplay.style.background = 'linear-gradient(135deg, rgba(255, 47, 0, 0.1) 0%, rgba(226, 255, 0, 0.1) 100%)';
      statusDisplay.style.borderColor = '#FF2F00';
      statusDisplay.style.borderWidth = '2px';
      
      // Reset background after a moment
      setTimeout(() => {
        statusDisplay.style.background = '#fff3cd';
        statusDisplay.style.borderColor = '#ffc107';
        statusDisplay.style.borderWidth = '1px';
      }, 3000);
    }

    async function resetAll() {
      if (!LOCATION_ID) {
        showError('No location selected. Please select a location from the dropdown above.');
        return;
      }
      
      if (!confirm('Reset all onboarding progress for this location?')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/onboarding/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            locationId: LOCATION_ID,
            updates: {
              locationVerified: false,
              domainConnected: false,
              courseCreated: false,
              paymentIntegrated: false,
              dismissed: false
            }
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: Reset failed`);
        }
        
        const updatedStatus = await response.json();
        displayStatus(updatedStatus);
        
        // Show success in status box
        const statusContent = document.getElementById('status-content');
        statusContent.textContent = `‚úÖ All progress reset successfully\n\n${JSON.stringify(updatedStatus, null, 2)}`;
      } catch (error) {
        console.error('Error resetting:', error);
        showError(`Failed to reset: ${error.message}`);
      }
    }

    function displayStatus(status) {
      currentStatus = status;
      const statusDisplay = document.getElementById('status-display');
      const statusContent = document.getElementById('status-content');
      statusContent.textContent = JSON.stringify(status, null, 2);
      statusDisplay.classList.add('show');
    }

    function setupAgency() {
      // Option 1: Use same window (no popup)
      if (confirm('You will be redirected to GoHighLevel for authorization. Continue?')) {
        // Save current URL to return after OAuth
        sessionStorage.setItem('oauth_return_url', window.location.href);
        sessionStorage.setItem('oauth_type', 'agency');
        
        // Redirect same window to OAuth
        window.location.href = `${API_BASE}/api/oauth/agency/install`;
      }
    }
    
    // Check if returning from OAuth
    window.addEventListener('DOMContentLoaded', async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const oauthSuccess = urlParams.get('oauth_success');
      const oauthType = sessionStorage.getItem('oauth_type');
      
      if (oauthSuccess === 'true' && oauthType === 'agency') {
        sessionStorage.removeItem('oauth_type');
        sessionStorage.removeItem('oauth_return_url');
        
        // Clear minimized state so widget shows full after OAuth
        localStorage.removeItem('cc360_widget_minimized');
        
        alert('Agency authorization successful! Widget will now work for all sub-accounts.');
        
        // Clean URL (preserve locationId param if present)
        const locationIdParam = urlParams.get('locationId');
        const newUrl = locationIdParam 
          ? `${window.location.pathname}?locationId=${locationIdParam}`
          : window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // Update button status and reload widget
        await updateAgencyButtonStatus();
        
        // Reload widget to show checklist (will auto-detect location)
        const existingWidget = document.getElementById('cc360-onboarding-widget');
        if (existingWidget) existingWidget.remove();
        const script = document.createElement('script');
        script.src = `${API_BASE}/widget.js`;
        script.setAttribute('data-api', API_BASE);
        document.body.appendChild(script);
      }
    });

    async function checkAgencyStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/agency/status`);
        const data = await response.json();
        
        if (data.authorized) {
          alert(`Agency Status: ‚úì Authorized\n\nAccount ID: ${data.installation?.accountId || 'N/A'}\nCreated: ${data.installation?.createdAt ? new Date(data.installation.createdAt).toLocaleString() : 'N/A'}`);
        } else {
          alert('Agency Status: ‚úó Not Authorized\n\nClick "Setup Agency OAuth" to authorize.');
        }
        displayStatus(data);
      } catch (error) {
        console.error('Error:', error);
        alert('Error checking agency status. See console for details.');
      }
    }

    async function clearAgencyAuth() {
      if (!confirm('This will clear the agency authorization. All sub-accounts will lose access until re-authorized. Continue?')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/installation?locationId=agency`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Agency authorization cleared!');
          // Update button status instead of full page reload
          await updateAgencyButtonStatus();
          // Reload widget to show "Setup Required" (will auto-detect location)
          const existingWidget = document.getElementById('cc360-onboarding-widget');
          if (existingWidget) existingWidget.remove();
          const script = document.createElement('script');
          script.src = `${API_BASE}/widget.js`;
          script.setAttribute('data-api', API_BASE);
          document.body.appendChild(script);
        } else {
          alert('Failed to clear agency authorization');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error clearing agency authorization. See console for details.');
      }
    }

    async function checkInstallation() {
      if (!LOCATION_ID) {
        showError('No location selected. Please select a location from the dropdown above.');
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/api/installation/check?locationId=${LOCATION_ID}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        const typeLabel = data.tokenType === 'agency' ? '(via Agency)' : '(Location-specific)';
        const statusContent = document.getElementById('status-content');
        statusContent.textContent = `Installation Status:\n\nInstalled: ${data.installed}\nHas Token: ${data.hasToken}\nToken Type: ${data.tokenType} ${typeLabel}\n\n${JSON.stringify(data, null, 2)}`;
        
        const statusDisplay = document.getElementById('status-display');
        statusDisplay.classList.add('show');
      } catch (error) {
        console.error('Error checking installation:', error);
        showError(`Failed to check installation: ${error.message}`);
      }
    }

    function resetWidget() {
      // Clear all widget state from localStorage
      localStorage.removeItem('cc360_widget_minimized');
      alert('Widget state cleared. Reloading page...');
      location.reload();
    }

    function reloadWidget() {
      if (window.cc360Widget && window.cc360Widget.reload) {
        window.cc360Widget.reload();
      } else {
        location.reload();
      }
    }

    async function clearLocationData() {
      if (!LOCATION_ID) {
        showError('No location selected. Please select a location from the dropdown above.');
        return;
      }
      if (!confirm(`‚ö†Ô∏è This will clear ALL data for location ${LOCATION_ID}:\n\n- All onboarding progress\n- Location-specific installation\n- Widget state (including dismissal)\n- Local storage (position, minimized state)\n\n‚úì Agency authorization will be preserved\n\nContinue?`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/test/clear-location`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ locationId: LOCATION_ID })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          console.log(`‚úì ${data.message} - Clearing local storage and reloading...`);
          
          // Clear all widget-related localStorage items (especially dismissed state)
          try {
            localStorage.removeItem('cc360_widget_minimized');
            localStorage.removeItem('cc360_widget_dismissed_permanently'); // Legacy, but clear anyway
            localStorage.removeItem('cc360_widget_position');
            localStorage.removeItem('cc360_widget_height');
          } catch (e) {
            console.error('Error clearing localStorage:', e);
          }
          
          // Reload page
          setTimeout(() => location.reload(), 500);
        } else {
          showError(`${data.error}: ${data.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error clearing location data:', error);
        showError(`Failed to clear location data: ${error.message}`);
      }
    }
  </script>
</body>
</html>

