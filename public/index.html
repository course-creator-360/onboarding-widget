<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CC360 Onboarding Widget - Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .demo-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
      max-width: 800px;
      width: 100%;
      padding: 48px;
    }
    h1 {
      color: #2c3e50;
      font-size: 32px;
      margin-bottom: 16px;
    }
    h2 {
      color: #667eea;
      font-size: 20px;
      margin-top: 32px;
      margin-bottom: 16px;
    }
    p {
      color: #6c757d;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    .info-box {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 16px;
      margin: 24px 0;
      border-radius: 4px;
    }
    .info-box strong {
      color: #2c3e50;
      display: block;
      margin-bottom: 8px;
    }
    code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      color: #e83e8c;
    }
    .controls {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    button:active {
      transform: translateY(0);
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    .endpoint-list {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 16px 0;
    }
    .endpoint-list li {
      margin-bottom: 8px;
      color: #495057;
    }
    .status-display {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      display: none;
    }
    .status-display.show {
      display: block;
    }
    .status-display pre {
      background: white;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      margin-top: 8px;
    }
    .badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="demo-container">
    <h1>üöÄ CC360 Onboarding Widget</h1>
    <p class="badge">Demo Mode</p>
    <p>
      This is a demo page for the CourseCreator360 onboarding widget. 
      The widget appears in the bottom-right corner and tracks onboarding progress.
    </p>

    <div class="info-box">
      <strong>Widget Configuration:</strong>
      <div style="margin-top: 12px;">
        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <strong style="color: #856404; display: block; margin-bottom: 6px;">‚ö†Ô∏è Testing on Demo Page:</strong>
          <p style="margin: 0; font-size: 13px; color: #856404; line-height: 1.5;">
            To test this demo page, add <code>?locationId=YOUR_LOCATION_ID</code> to the URL.
            The widget will auto-detect it from the query parameter.
            <br><br>
            Example: <code>https://your-domain.com/?locationId=L851uHvru1ipOe8DIwNS</code>
          </p>
        </div>
        <p style="margin: 0; font-size: 13px; color: #6c757d;">
          Detected Location: <code id="currentLocationId">Auto-detecting...</code><br>
          API Base: <code id="apiBaseUrl">Loading...</code>
        </p>
      </div>
    </div>

    <h2>Agency Setup</h2>
    <p>Configure agency-level authorization (one-time setup):</p>
    
    <div class="controls">
      <button id="setupAgencyBtn" onclick="setupAgency()">üîë Setup Agency OAuth</button>
      <button onclick="checkAgencyStatus()">Check Agency Status</button>
      <button class="secondary" onclick="clearAgencyAuth()">Clear Agency Auth</button>
    </div>

    <h2>Widget Testing</h2>
    <p>Test widget behavior and onboarding progress:</p>
    
    <div class="controls">
      <button onclick="checkInstallation()">Check Installation</button>
      <button onclick="resetWidget()">Reset Widget State</button>
      <button class="secondary" onclick="reloadWidget()">Reload Widget</button>
      <button class="secondary" onclick="clearLocationData()" style="background: #dc3545;">üóëÔ∏è Clear Location Data</button>
    </div>

    <h2>Onboarding Progress</h2>
    <p>Simulate onboarding steps for the current location:</p>
    
    <div class="controls">
      <button onclick="toggleStep('paymentIntegrated')">Toggle Payment</button>
      <button onclick="toggleStep('courseCreated')">Toggle Course</button>
      <button onclick="toggleStep('domainConnected')">Toggle Domain</button>
      <button class="secondary" onclick="resetAll()">Reset All</button>
      <button class="secondary" onclick="checkStatus()">Check Status</button>
    </div>

    <div id="status-display" class="status-display">
      <strong>Current Status:</strong>
      <pre id="status-content"></pre>
    </div>

    <h2>Available Endpoints</h2>
    <div class="endpoint-list">
      <ul>
        <li><code>GET /api/status?locationId=...</code> - Get current checklist status</li>
        <li><code>GET /api/events?locationId=...</code> - SSE stream for real-time updates</li>
        <li><code>GET /api/onboarding/:locationId/check-products</code> - Check if products exist (polling)</li>
        <li><code>POST /api/dismiss</code> - Dismiss the widget</li>
        <li><code>POST /api/toggle</code> - Toggle a specific field (testing)</li>
        <li><code>POST /api/mock/set</code> - Update checklist flags (testing)</li>
        <li><code>POST /api/test/clear-location</code> - Clear location data (keep agency auth)</li>
        <li><code>GET /api/oauth/install</code> - OAuth installation flow</li>
        <li><code>POST /api/webhooks/ghl</code> - GHL webhook receiver</li>
      </ul>
    </div>

    <h2>How It Works</h2>
    <p>
      <strong>üéØ Auto-Detection:</strong> The widget now automatically detects the location ID when embedded in the GHL dashboard. 
      It checks multiple sources including the URL path, query parameters, GHL context objects, and parent window URLs (for iframes). 
      This eliminates the need for manual configuration in production.
    </p>
    <p>
      <strong>üîÑ Real-Time Updates:</strong> The widget uses Server-Sent Events (SSE) for real-time updates. When you click 
      the testing buttons above, the widget will automatically update without refreshing the page.
    </p>
    <p>
      <strong>üì¶ Product Detection:</strong> The widget uses <strong>fetch interception</strong> to detect 
      when products/courses are created in GHL's admin dashboard. When the widget is loaded as custom JS 
      in the agency, it intercepts GHL's API calls and triggers a status check when product creation is detected.
    </p>
    <p> 
      <strong>üîó Webhook Integration:</strong> Other events (domain connection, payment integration, orders) use webhooks from GoHighLevel 
      for real-time updates.
    </p>
  </div>

  <!-- Widget loading script -->
  <script>
    let LOCATION_ID = null;
    let API_BASE = window.location.origin; // Use current origin by default

    // Detect location ID from URL (for demo/testing)
    function detectLocationFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const locationId = urlParams.get('locationId');
      if (locationId) {
        LOCATION_ID = locationId;
        document.getElementById('currentLocationId').textContent = locationId;
        console.log('Detected location ID from URL:', locationId);
        return locationId;
      }
      
      // Check URL path
      const pathMatch = window.location.pathname.match(/\/location\/([^\/]+)/);
      if (pathMatch && pathMatch[1]) {
        LOCATION_ID = pathMatch[1];
        document.getElementById('currentLocationId').textContent = pathMatch[1];
        console.log('Detected location ID from path:', pathMatch[1]);
        return pathMatch[1];
      }
      
      document.getElementById('currentLocationId').textContent = 'Not detected (add ?locationId=... to URL)';
      return null;
    }
    
    // Update agency button status
    async function updateAgencyButtonStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/agency/status`);
        const data = await response.json();
        
        const button = document.getElementById('setupAgencyBtn');
        if (data.authorized) {
          button.textContent = '‚úì Agency OAuth Connected';
          button.classList.add('success');
          button.onclick = () => {
            if (confirm('Agency OAuth is already set up. Do you want to re-authorize?')) {
              setupAgency();
            }
          };
        } else {
          button.textContent = 'üîë Setup Agency OAuth';
          button.classList.remove('success');
          button.onclick = setupAgency;
        }
      } catch (error) {
        console.error('Error checking agency status:', error);
      }
    }
    
    // Load API base and widget on page load
    window.addEventListener('DOMContentLoaded', async function() {
      // Always use current origin for API calls (fixes Vercel preview URL issues)
      API_BASE = window.location.origin;
      document.getElementById('apiBaseUrl').textContent = API_BASE;
      
      // Detect location ID from URL
      detectLocationFromUrl();
      
      // Check agency OAuth status and update button
      await updateAgencyButtonStatus();
      
      // Auto-load widget - it will auto-detect location ID from URL
      const script = document.createElement('script');
      script.src = `${API_BASE}/widget.js`;
      script.setAttribute('data-api', API_BASE);
      // Note: no data-location attribute - widget will auto-detect from UserContext/URL
      document.body.appendChild(script);
      console.log('Widget loaded - will auto-detect location ID');
    });
  </script>

  <script>
    let currentStatus = {};

    async function checkStatus() {
      if (!LOCATION_ID) {
        alert('Please add ?locationId=YOUR_LOCATION_ID to the URL to test with a specific location');
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/api/status?locationId=${LOCATION_ID}`);
        currentStatus = await response.json();
        displayStatus(currentStatus);
      } catch (error) {
        console.error('Error fetching status:', error);
      }
    }

    async function toggleStep(step) {
      if (!LOCATION_ID) {
        alert('Please add ?locationId=YOUR_LOCATION_ID to the URL to test with a specific location');
        return;
      }
      try {
        // Backend handles the toggle logic - just send the field name
        const response = await fetch(`${API_BASE}/api/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            locationId: LOCATION_ID,
            field: step
          })
        });
        
        const updatedStatus = await response.json();
        displayStatus(updatedStatus);
      } catch (error) {
        console.error('Error toggling step:', error);
      }
    }

    async function resetAll() {
      if (!LOCATION_ID) {
        alert('Please add ?locationId=YOUR_LOCATION_ID to the URL to test with a specific location');
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/api/mock/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            locationId: LOCATION_ID,
            updates: {
              domainConnected: false,
              courseCreated: false,
              paymentIntegrated: false,
              dismissed: false
            }
          })
        });
        
        const updatedStatus = await response.json();
        displayStatus(updatedStatus);
      } catch (error) {
        console.error('Error resetting:', error);
      }
    }

    function displayStatus(status) {
      currentStatus = status;
      const statusDisplay = document.getElementById('status-display');
      const statusContent = document.getElementById('status-content');
      statusContent.textContent = JSON.stringify(status, null, 2);
      statusDisplay.classList.add('show');
    }

    function setupAgency() {
      // Option 1: Use same window (no popup)
      if (confirm('You will be redirected to GoHighLevel for authorization. Continue?')) {
        // Save current URL to return after OAuth
        sessionStorage.setItem('oauth_return_url', window.location.href);
        sessionStorage.setItem('oauth_type', 'agency');
        
        // Redirect same window to OAuth
        window.location.href = `${API_BASE}/api/oauth/agency/install`;
      }
    }
    
    // Check if returning from OAuth
    window.addEventListener('DOMContentLoaded', async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const oauthSuccess = urlParams.get('oauth_success');
      const oauthType = sessionStorage.getItem('oauth_type');
      
      if (oauthSuccess === 'true' && oauthType === 'agency') {
        sessionStorage.removeItem('oauth_type');
        sessionStorage.removeItem('oauth_return_url');
        
        // Clear minimized state so widget shows full after OAuth
        localStorage.removeItem('cc360_widget_minimized');
        
        alert('Agency authorization successful! Widget will now work for all sub-accounts.');
        
        // Clean URL (preserve locationId param if present)
        const locationIdParam = urlParams.get('locationId');
        const newUrl = locationIdParam 
          ? `${window.location.pathname}?locationId=${locationIdParam}`
          : window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // Update button status and reload widget
        await updateAgencyButtonStatus();
        
        // Reload widget to show checklist (will auto-detect location)
        const existingWidget = document.getElementById('cc360-onboarding-widget');
        if (existingWidget) existingWidget.remove();
        const script = document.createElement('script');
        script.src = `${API_BASE}/widget.js`;
        script.setAttribute('data-api', API_BASE);
        document.body.appendChild(script);
      }
    });

    async function checkAgencyStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/agency/status`);
        const data = await response.json();
        
        if (data.authorized) {
          alert(`Agency Status: ‚úì Authorized\n\nAccount ID: ${data.installation?.accountId || 'N/A'}\nCreated: ${data.installation?.createdAt ? new Date(data.installation.createdAt).toLocaleString() : 'N/A'}`);
        } else {
          alert('Agency Status: ‚úó Not Authorized\n\nClick "Setup Agency OAuth" to authorize.');
        }
        displayStatus(data);
      } catch (error) {
        console.error('Error:', error);
        alert('Error checking agency status. See console for details.');
      }
    }

    async function clearAgencyAuth() {
      if (!confirm('This will clear the agency authorization. All sub-accounts will lose access until re-authorized. Continue?')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/installation?locationId=agency`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Agency authorization cleared!');
          // Update button status instead of full page reload
          await updateAgencyButtonStatus();
          // Reload widget to show "Setup Required" (will auto-detect location)
          const existingWidget = document.getElementById('cc360-onboarding-widget');
          if (existingWidget) existingWidget.remove();
          const script = document.createElement('script');
          script.src = `${API_BASE}/widget.js`;
          script.setAttribute('data-api', API_BASE);
          document.body.appendChild(script);
        } else {
          alert('Failed to clear agency authorization');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error clearing agency authorization. See console for details.');
      }
    }

    async function checkInstallation() {
      if (!LOCATION_ID) {
        alert('Please add ?locationId=YOUR_LOCATION_ID to the URL to test with a specific location');
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/api/installation/check?locationId=${LOCATION_ID}`);
        const data = await response.json();
        
        const typeLabel = data.tokenType === 'agency' ? '(via Agency)' : '(Location-specific)';
        alert(`Installation Status:\n\nInstalled: ${data.installed}\nHas Token: ${data.hasToken}\nToken Type: ${data.tokenType} ${typeLabel}`);
        displayStatus(data);
      } catch (error) {
        console.error('Error checking installation:', error);
        alert('Error checking installation. See console for details.');
      }
    }

    function resetWidget() {
      // Clear all widget state from localStorage
      localStorage.removeItem('cc360_widget_minimized');
      alert('Widget state cleared. Reloading page...');
      location.reload();
    }

    function reloadWidget() {
      if (window.cc360Widget && window.cc360Widget.reload) {
        window.cc360Widget.reload();
      } else {
        location.reload();
      }
    }

    async function clearLocationData() {
      if (!LOCATION_ID) {
        alert('Please add ?locationId=YOUR_LOCATION_ID to the URL to test with a specific location');
        return;
      }
      if (!confirm(`‚ö†Ô∏è This will clear ALL data for location ${LOCATION_ID}:\n\n- All onboarding progress\n- Location-specific installation\n- Widget state (including dismissal)\n- Local storage (position, minimized state)\n\n‚úì Agency authorization will be preserved\n\nContinue?`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/test/clear-location`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ locationId: LOCATION_ID })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert(`‚úì ${data.message}\n\nClearing local storage and reloading...`);
          
          // Clear all widget-related localStorage items (especially dismissed state)
          try {
            localStorage.removeItem('cc360_widget_minimized');
            localStorage.removeItem('cc360_widget_dismissed_permanently'); // Legacy, but clear anyway
            localStorage.removeItem('cc360_widget_position');
            localStorage.removeItem('cc360_widget_height');
          } catch (e) {
            console.error('Error clearing localStorage:', e);
          }
          
          // Reload page
          setTimeout(() => location.reload(), 500);
        } else {
          alert(`Error: ${data.error}\n\n${data.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error clearing location data:', error);
        alert('Error clearing location data. See console for details.');
      }
    }
  </script>
</body>
</html>

