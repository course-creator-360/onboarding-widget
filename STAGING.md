# Staging Environment Setup

This document describes how to set up and deploy the staging environment.

## Overview

The staging environment is deployed from the `staging` branch and uses separate configuration from production to allow safe testing before production deployment.

## Branch Strategy

- **`main`** → Production environment
- **`staging`** → Staging environment (preview/testing)

## Vercel Setup

### Option 1: Vercel Preview Deployments (Recommended)

Vercel automatically creates preview deployments for the `staging` branch. This is the easiest approach:

1. **Connect Repository to Vercel**
   - Go to Vercel Dashboard → Add New Project
   - Connect your repository
   - Vercel will detect the project automatically

2. **Configure Branch Deployments**
   - Go to Project Settings → Git
   - Enable "Production Branch" → Set to `main`
   - Enable "Preview Deployments" → All branches (or just `staging`)

3. **Set Staging Environment Variables**
   - Go to Project Settings → Environment Variables
   - Add variables with scope: **Preview** (or **Staging** if you create a custom environment)
   - Use values from `env.staging.template`

4. **Deploy**
   - Push to `staging` branch → Vercel auto-deploys
   - Each push creates a new preview URL
   - Or use Vercel CLI: `vercel --target preview`

### Option 2: Separate Vercel Project

Create a separate Vercel project for staging:

1. **Create New Project**
   - Vercel Dashboard → Add New Project
   - Connect same repository
   - Name it: `onboarding-widget-staging`

2. **Configure Branch**
   - Set Production Branch to `staging`
   - This project will only deploy from `staging` branch

3. **Set Environment Variables**
   - Add all staging environment variables
   - Use staging database, GHL credentials, etc.

## Environment Variables

Copy `env.staging.template` to `.env.staging` and fill in staging values:

```bash
cp env.staging.template .env.staging
# Edit .env.staging with staging credentials
```

### Key Differences from Production

- **Database**: Use separate staging PostgreSQL database
- **GHL OAuth**: Create separate GHL Marketplace app for staging
- **Userpilot**: Use staging API keys and tokens
- **Domain**: Staging URLs (auto-generated by Vercel or custom domain)

## Database Setup

### Option 1: Vercel Postgres (Staging)

1. Create a new Postgres database in Vercel
2. Name it: `onboarding-staging`
3. Link it to your staging project
4. Vercel auto-injects `DATABASE_URL` and `POSTGRES_URL`

### Option 2: External Staging Database

Use a separate PostgreSQL instance:
- Neon, Supabase, or other provider
- Set `DATABASE_URL` and `POSTGRES_URL` in Vercel environment variables

## GHL Marketplace Setup

Create a separate GHL Marketplace app for staging:

1. **Create Staging App**
   - Go to https://marketplace.gohighlevel.com/
   - Create new app: `CourseCreator360 Onboarding Widget (Staging)`

2. **Configure OAuth**
   - Redirect URI: `https://your-staging-app.vercel.app/oauth/callback`
   - Same scopes as production

3. **Set Webhook URL**
   - Webhook URL: `https://your-staging-app.vercel.app/api/webhooks/ghl`

## Deployment Workflow

### Deploy to Staging

```bash
# Make sure you're on staging branch
git checkout staging

# Make your changes
# ... edit files ...

# Commit and push
git add .
git commit -m "Your changes"
git push origin staging

# Vercel automatically deploys (if configured)
# Or deploy manually:
vercel --target preview
```

### Promote Staging to Production

```bash
# Merge staging into main
git checkout main
git merge staging
git push origin main

# Vercel automatically deploys to production
```

## Testing Checklist

Before promoting staging to production:

- [ ] OAuth flow works correctly
- [ ] Widget loads and displays properly
- [ ] Database migrations run successfully
- [ ] Webhooks are receiving events
- [ ] Status polling works
- [ ] Sub-account tracking works
- [ ] Feature flags work as expected
- [ ] Location filtering works (if configured)
- [ ] Userpilot tracking works (if enabled)

## URLs

- **Staging**: `https://your-staging-app.vercel.app` (or preview URL)
- **Production**: `https://your-production-app.vercel.app`

## Troubleshooting

### Staging Deployments Not Working

1. Check Vercel project settings → Git → Branch configuration
2. Verify environment variables are set for Preview/Staging scope
3. Check Vercel build logs for errors

### Database Connection Issues

1. Verify `DATABASE_URL` is set correctly in Vercel
2. Check database is accessible from Vercel (firewall/IP restrictions)
3. Ensure connection pooling parameters are set

### OAuth Redirect Issues

1. Verify `GHL_REDIRECT_URI` matches staging URL exactly
2. Check GHL Marketplace app redirect URI is updated
3. Clear browser cache and cookies

## Local Staging Testing

To test staging configuration locally:

```bash
# Use staging environment file
cp .env.staging .env

# Or load staging env vars
export $(cat .env.staging | xargs)

# Start server
make start
```

## Migration Strategy

Run migrations separately for staging:

```bash
# After deploying to staging
curl -X POST https://your-staging-app.vercel.app/api/migrate \
  -H "x-vercel-migrate-secret: your-staging-secret"
```

Always test migrations in staging before running in production!
