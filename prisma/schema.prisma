generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL")
}

model Installation {
  id           String   @id @default(cuid())
  locationId   String   @unique @map("location_id")
  accountId    String?  @map("account_id")
  accessToken  String   @map("access_token")
  refreshToken String?  @map("refresh_token")
  expiresAt    BigInt?  @map("expires_at")
  scope        String?
  tokenType    String   @default("location") @map("token_type")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([tokenType])
  @@map("installations")
}

model Onboarding {
  id                String   @id @default(cuid())
  locationId        String   @unique @map("location_id")
  locationVerified  Boolean  @default(false) @map("location_verified")
  domainConnected   Boolean  @default(false) @map("domain_connected")
  courseCreated     Boolean  @default(false) @map("course_created")
  productAttached   Boolean  @default(false) @map("product_attached")
  paymentIntegrated Boolean  @default(false) @map("payment_integrated")
  dismissed         Boolean  @default(false)
  surveyCompleted   Boolean  @default(false) @map("survey_completed")
  surveyResponses   Json?    @map("survey_responses")
  bookingCancelled  Boolean  @default(false) @map("booking_cancelled")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([locationId])
  @@map("onboarding")
}

model EventLog {
  id         String   @id @default(cuid())
  locationId String?  @map("location_id")
  eventType  String   @map("event_type")
  payload    Json
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([locationId])
  @@index([eventType])
  @@index([createdAt])
  @@map("event_log")
}

model SubAccount {
  id              String   @id @default(cuid())
  locationId      String   @unique @map("location_id")
  accountId       String   @map("account_id")
  locationName    String?  @map("location_name")
  companyId       String?  @map("company_id")
  firstAccessedAt DateTime @default(now()) @map("first_accessed_at")
  lastAccessedAt  DateTime @updatedAt @map("last_accessed_at")
  isActive        Boolean  @default(true) @map("is_active")
  metadata        Json?

  @@index([accountId])
  @@index([companyId])
  @@index([firstAccessedAt])
  @@index([isActive])
  @@map("sub_accounts")
}

// Cache of all locations from GHL agencies
// Synced on widget init for fast lookups
// MULTI-TENANT: Each agency (accountId) has their own set of locations
// This allows multiple GHL agencies to use the same app instance
model AgencyLocation {
  locationId   String   @id @map("location_id") // GHL location ID (globally unique)
  accountId    String   @map("account_id") // GHL agency account ID (multi-tenant key)
  companyId    String?  @map("company_id") // GHL company ID
  name         String // Location name
  email        String?
  phone        String?
  website      String?
  address      String?
  city         String?
  state        String?
  country      String?
  timezone     String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  lastSyncedAt DateTime @default(now()) @map("last_synced_at") // When synced from GHL

  @@index([accountId])
  @@index([companyId])
  @@index([lastSyncedAt])
  @@map("agency_locations")
}
